import { readdirSync, readFileSync, writeFileSync, watch } from "node:fs";
import { join, resolve } from "node:path";

const ROOT = resolve(import.meta.dirname, "..");
const LOCALES_DIR = join(ROOT, "public", "locales");
const OUTPUT_FILE = join(ROOT, "src", "features", "i18n", "locale-keys.gen.ts");

function collectKeys() {
  const files = readdirSync(LOCALES_DIR).filter((f) => f.endsWith(".json"));
  const keys = new Set();

  for (const file of files) {
    const content = JSON.parse(readFileSync(join(LOCALES_DIR, file), "utf-8"));
    for (const key of Object.keys(content)) {
      keys.add(key);
    }
  }

  return [...keys].sort();
}

function generate() {
  const keys = collectKeys();
  const union = keys.map((k) => `  | "${k}"`).join("\n");

  const content = [
    "// This file is auto-generated by scripts/generate-locale-keys.mjs",
    "// Do not edit manually.",
    "",
    `export type LocaleKey =\n${union};`,
    "",
  ].join("\n");

  writeFileSync(OUTPUT_FILE, content, "utf-8");
  console.log(
    `[generate-locale-keys] Generated ${keys.length} keys â†’ src/features/i18n/locale-keys.gen.ts`,
  );
}

// --- CLI ---
const args = process.argv.slice(2);

if (args.includes("--watch")) {
  generate();
  console.log(`[generate-locale-keys] Watching ${LOCALES_DIR} for changes...`);
  watch(LOCALES_DIR, { recursive: false }, (event, filename) => {
    if (filename?.endsWith(".json")) {
      console.log(`[generate-locale-keys] ${filename} changed, regenerating...`);
      generate();
    }
  });
} else {
  generate();
}
